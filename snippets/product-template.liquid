{%- liquid
  assign current_variant = product.selected_or_first_available_variant

  unless thumbnail_position
    assign thumbnail_position = 'beside'
  endunless

  assign product_zoom_size = '1800x1800'
  assign product_image_size = '620x'

  case image_container_width
    when 'small'
      assign product_image_width = 'medium-up--two-fifths'
      assign product_description_width = 'medium-up--three-fifths'
      assign product_image_size = '480x'
    when 'medium'
      assign product_image_width = 'medium-up--one-half'
      assign product_description_width = 'medium-up--one-half'
      assign product_image_size = '620x'
    when 'large'
      assign product_image_width = 'medium-up--three-fifths'
      assign product_description_width = 'medium-up--two-fifths'
      assign product_image_size = '740x'
  endcase

  assign product_img_structure = product.featured_media | img_url: '1x1' | replace: '_1x1.', '_{width}x.'
-%}

<div id="ProductSection-{{ section_id }}-{{ product.id }}"
        class="product-section"
        data-section-id="{{ section_id }}"
        data-product-id="{{ product.id }}"
        data-section-type="product"
        data-product-handle="{{ product.handle }}"
        data-product-title="{{ product.title | escape }}"
        data-product-url="{{ product.url | within: collection }}"
        data-aspect-ratio="{{ 100 | divided_by: product.featured_media.aspect_ratio }}"
        data-img-url="{{ product_img_structure }}"
        {% unless isModal %}
          data-history="true"
        {% endunless %}
        data-modal="{{ isModal }}">

  {%- render 'product-template-variables', product: product, current_variant: current_variant -%}

  <div class="page-content page-content--product">
    <div class="page-width">

      {%- render 'breadcrumbs', force_show: true -%}

      <div class="grid{% unless image_position == 'left' %} grid--product-images-right{% endunless %}{% if mobile_layout == 'partial' %} grid--product-images--partial{% endif %}">
        {%- if image_position == 'left' -%}
          <div class="grid__item {{ product_image_width }} product-single__sticky">
            {%- render 'product-images',
                    section_id: section_id,
                    product: product,
                    isModal: isModal,
                    image_position: image_position,
                    product_zoom_enable: product_zoom_enable,
                    product_zoom_size: product_zoom_size,
                    product_image_size: product_image_size,
                    thumbnail_arrows: thumbnail_arrows,
                    thumbnail_position: thumbnail_position,
                    video_looping: video_looping,
                    video_style: video_style
            -%}
          </div>
        {%- endif -%}

        <div class="grid__item {{ product_description_width }}">

          <div class="product-single__meta">
            <div class="product-block product-block--header">
              {%- if settings.show_breadcrumbs and isModal != true -%}
                {%- render 'breadcrumbs' -%}
              {%- endif -%}

              {%- if settings.vendor_enable -%}
                <div class="product-single__vendor">
                  {%- assign vendor_handle = product.vendor | handleize -%}
                  {%- if collections[vendor_handle] != empty -%}
                    <a href="{{ routes.collections_url }}/{{ collections[vendor_handle].handle }}">
                      {{ collections[vendor_handle].title }}
                    </a>
                  {%- else -%}
                    {{ product.vendor | link_to_vendor }}
                  {%- endif -%}
                </div>
              {%- endif -%}

              {%- if isModal -%}
                <p class="h2 product-single__title">
                  {{ product.title }}
                </p>
              {%- else -%}
                <h1 class="h2 product-single__title">
                  {%- unless product.empty? -%}
                    {{ product.title }}
                  {%- else -%}
                    {{ 'home_page.onboarding.product_title' | t }}
                  {%- endunless -%}
                </h1>
              {%- endif -%}

              <div class="product__price-mobile" {{ block.shopify_attributes }}>
                … <!-- no changes here, left intact -->
              </div>

              {%- if sku_enable -%}
                <p data-sku class="product-single__sku">
                  {%- if current_variant.sku -%}
                    {{ current_variant.sku }}
                  {%- endif -%}
                </p>
              {%- endif -%}
            </div>

            <div data-product-blocks>
              {%- capture form_id -%}AddToCartForm-{{ section_id }}-{{ product.id }}{%- endcapture -%}

              {%- for block in blocks -%}
                {%- case block.type -%}
                  …
                  {%- when 'buy_buttons' -%}
                    <div class="product-block product-block--buy-buttons" {{ block.shopify_attributes }}>
                      {%- unless product.empty? -%}
                        <div class="product-block">
                          <div class="product__header-sticky">
                            <p class="product__title-sticky">{{ product.title }}</p>
                            <div class="product__price-sticky">{{ product_price }}</div>
                          </div>

                          <div class="product__variants-sticky"></div>

                          {%- render 'product-form',
                                  form_id: form_id,
                                  product: product,
                                  show_dynamic_checkout: block.settings.show_dynamic_checkout,
                                  current_variant: current_variant
                          -%}

                          <!-- ✅ Klaviyo Back In Stock (SMS version) -->
                          <div class="klaviyo-bis-trigger"
                               data-product-id="{{ product.id }}"
                               data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                               data-product-handle="{{ product.handle }}"
                               {{ block.shopify_attributes }}>
                            <button type="button"
                                    class="btn klaviyo-notify-btn {% if block.settings.button_style == 'primary' %}btn--primary{% elsif block.settings.button_style == 'secondary' %}btn--secondary{% endif %}"
                                    aria-label="Text me when this item is available"
                                    style="display:none;">
                              {{ block.settings.button_text | default: 'Text Me When Available' }}
                            </button>
                          </div>
                          <p class="notify-subtext" style="font-size:0.85rem; margin-top:0.25rem;">
                            You’ll receive a text once this piece is back in stock.
                          </p>

                          <script>
                            (function() {
                              var section = document.getElementById('ProductSection-{{ section_id }}-{{ product.id }}');
                              if (!section) return;

                              var notifyWrap = section.querySelector('.klaviyo-bis-trigger');
                              var notifyBtn  = section.querySelector('.klaviyo-notify-btn');
                              if (!notifyWrap || !notifyBtn) return;

                              var productVariants = {{ product.variants | json }};
                              var currentVariant  = {{ product.selected_or_first_available_variant | json }};

                              function toggleKlaviyoNotifyButton(variant) {
                                if (!variant) return;
                                if (!variant.available) {
                                  notifyBtn.style.display = 'block';
                                  notifyWrap.setAttribute('data-variant-id', variant.id);
                                } else {
                                  notifyBtn.style.display = 'none';
                                }
                              }

                              toggleKlaviyoNotifyButton(currentVariant);

                              section.addEventListener('change', function(e) {
                                var target = e.target;
                                if (!target) return;
                                if (target.matches('[name="id"], input[type="radio"][name^="options"]')) {
                                  var selectedId = target.value;
                                  var variant = productVariants.find(function(v){ return String(v.id) === String(selectedId); });

                                  if (!variant) {
                                    var selectId = section.querySelector('select[name="id"]');
                                    if (selectId) {
                                      variant = productVariants.find(function(v){ return String(v.id) === String(selectId.value); });
                                    }
                                  }
                                  if (variant) toggleKlaviyoNotifyButton(variant);
                                }
                              });

                              section.addEventListener('variant:change', function(e) {
                                if (e && e.detail && e.detail.variant) {
                                  toggleKlaviyoNotifyButton(e.detail.variant);
                                }
                              });
                            })();
                          </script>

                          <style>
                            .klaviyo-notify-btn {
                              margin-top: 0.75rem;
                              width: 100%;
                            }
                          </style>
                          <!-- ✅ End Klaviyo BIS -->
                        </div>
                      {%- endunless -%}

                      {%- if block.settings.surface_pickup_enable -%}
                        <div data-store-availability-holder data-product-name="{{ product.title | escape }}" data-base-url="{{ shop.url }}{{ routes.root_url }}"></div>
                      {%- endif -%}
                    </div>
                  …
                {%- endcase -%}
              {%- endfor -%}
            </div>
          </div>
        </div>

        …
      </div>
    </div>
  </div>
</div>

<style>
  @font-face {
    font-family: TwCenMTStd;
    src: url({{ 'TwCenMTStd-Light.woff2' | asset_url }}) format('woff2'),
    url({{ 'TwCenMTStd-Light.woff' | asset_url }}) format('woff');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }
</style>

<script src="{{ 'readmore.min.js' | asset_url }}"></script>
<script>…</script>
